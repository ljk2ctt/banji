<?phpnamespace Home\Model;class MessageModel extends \Common\Model\MessageModel {    protected $_validate = array(        array('title', 'require', '请填写标题！',self::MUST_VALIDATE),        array('content', 'require', '请填写内容！',self::MUST_VALIDATE),        array('class_id', 'require', '请选择班级！',self::MUST_VALIDATE),        array('type', 'require', '请选择类型！',self::MUST_VALIDATE),    );    protected $_auto  =array(        array('addtime',NOW_TIME),    );    //接收者的id 用于程序条用传入 切避免覆盖I(member_ids)    public $member_ids='';    protected function _after_insert($data, $options) {        $class_id   =   $data['class_id'];        $cinfo=M('Class')->find($class_id);        if(empty($cinfo))        {            $this->error='所选班级不存在';            return false;        }        //0 所有人 1 老师 2 家委会 3家长 4指定某些人        $group_id=intval($data['group_id']);        //筛选出接受者的member_id        $Model  =   M();        if(0===$group_id)        {            $teacher_member_query=$Model->table('__MEMBER__ m')                    ->join('__TEACHER__ t on t.id=m.teacher_id','left')                    ->join('__TEACHER_SUBJECT_CLASS_ACCESS__ tsca on tsca.teacher_id=t.id','left')                    ->where(array('tsca.class_id'=>$class_id))->field('m.id id')->select();            foreach ($teacher_member_query as $member_id)            {                $teacher_member_ids[]=$member_id['id'];            }            $parent_member_query=$Model->table('__MEMBER__ m')                    ->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','left')                    ->where(array('s.class_id'=>$class_id))->field('m.id id')->select();            foreach ($parent_member_query as $member_id)            {                $parent_member_ids[]=$member_id['id'];            }            $get_member_ids= array_unique(array_merge($teacher_member_ids,$parent_member_ids));                    }        elseif(1===$group_id)        {            $teacher_member_query=$Model->table('__MEMBER__ m')                    ->join('__TEACHER__ t on t.id=m.teacher_id','left')                    ->join('__TEACHER_SUBJECT_CLASS_ACCESS__ tsca on tsca.teacher_id=t.id','left')                    ->where(array('tsca.class_id'=>$class_id))->field('m.id id')->select();            foreach ($teacher_member_query as $member_id)            {                $teacher_member_ids[]=$member_id['id'];            }            $get_member_ids= $teacher_member_ids;                    }        elseif(2===$group_id)        {            $parent_member_query=$Model->table('__MEMBER__ m')                    ->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','left')                    ->join('__PTA__ pta on find_in_set(pta.id,m.pta_id) and pta.class_id=s.class_id','left')                    ->where(array('pta.class_id'=>$class_id))->field('m.id id')->select();             foreach ($parent_member_query as $member_id)            {                $parent_member_ids[]=$member_id['id'];            }            $get_member_ids= $parent_member_ids;        }        elseif(3===$group_id)        {            $parent_member_query=$Model->table('__MEMBER__ m')                    ->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','left')                    ->join('__PTA__ pta on !find_in_set(pta.id,m.pta_id) and pta.class_id=s.class_id','left')                    ->where(array('s.class_id'=>$class_id))->field('m.id id')->select();            foreach ($parent_member_query as $member_id)            {                $parent_member_ids[]=$member_id['id'];            }            $get_member_ids= $parent_member_ids;        }        elseif(4===$group_id)        {            if(empty($this->member_ids))            {                $this->error='请选择接收人';                return false;            }            $member_ids=  explode(',', $this->member_ids);                        $teacher_member_query=$Model->table('__MEMBER__ m')                    ->join('__TEACHER__ t on t.id=m.teacher_id','left')                    ->join('__TEACHER_SUBJECT_CLASS_ACCESS__ tsca on tsca.teacher_id=t.id','left')                    ->where(array('tsca.class_id'=>$class_id))->field('m.id id')->select();            foreach ($teacher_member_query as $member_id)            {                $teacher_member_ids[]=$member_id['id'];            }            $parent_member_query=$Model->table('__MEMBER__ m')                    ->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','left')                    ->where(array('s.class_id'=>$class_id))->field('m.id id')->select();            foreach ($parent_member_query as $member_id)            {                $parent_member_ids[]=$member_id['id'];            }            $all_member_ids= array_unique(array_merge($teacher_member_ids,$parent_member_ids));             foreach($member_ids as $member_id)            {                if(!in_array($member_id, $all_member_ids))                {                    $this->error=$member_id.'不属于该班级';                    return false;                }            }            $get_member_ids=   $member_ids;        }        else {            $this->error='不正确的参数group_id'.$group_id;            return false;        }        //排除发送者自己        if(is_array($get_member_ids))        {            $get_member_ids=  array_unique($get_member_ids);        }        if(in_array($data['member_id'],$get_member_ids))        {            array_unset($get_member_ids, $data['member_id']);        }        if(empty($get_member_ids))        {            $this->error='没有接收者';            return false;        }        $this->member_ids=$get_member_ids;        $readdata['message_id']=$data['id'];        $message_type=$Model->table('__MESSAGE_TYPE__')->getFieldById($data['type'],'name');        $form_member_info=D('Member')->find($data['member_id']);        if(in_array($class_id,$form_member_info['teach_class_ids']))        {            if (preg_match("/^[\x81-\xfe][\x40-\xfe]?/",$form_member_info['real_name'])) {                $former=substr($form_member_info['real_name'], 0,3);            }            else            {                $former=  substr($form_member_info['real_name'], 0,1);            }            $former.='老师';            if($form_member_info['tinfo']['master_class_id']==$class_id)            {                $former.='(班主任)';            }            else            {                foreach($form_member_info['tinfo']['cinfos'] as $class)                {                    if($class['id']==$class_id)                    {                        $former.='('.$class['my_role']['subject'].')';                        break;                    }                }                            }        }        elseif(in_array($class_id,$form_member_info['pta_class_ids']))        {            $former=$form_member_info['real_name'].'(家委会)';        }        else{            $former=$form_member_info['real_name'].'(家长)';        }                $classInfo  =   $Model->table('__CLASS__')->find($class_id);        $temp_send_arr=array();        foreach($get_member_ids as $member_id)        {            $student_infos=$Model->table('__MEMBER__ m')->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','LEFT')->where(array('s.class_id'=>$data['class_id'],'m.id'=>$member_id))->select();            $student_ids=array();            foreach($student_infos as $student_info)            {                $student_ids[]=$student_info['id'];            }                    $readdata['student_ids']=  implode(',', $student_ids);            $readdata['member_id']=$member_id;            $read_id=$Model->table('__MESSAGE_READ__')->add($readdata);            if($data['member_id']>0)            {                $minfo=$Model->table('__MEMBER__')->find($member_id);                $openid=$minfo['openid'];                if($openid!='')                {                    //查询出关联小孩的名字                    $student_name_arr=$Model->table('__STUDENT__')->where(array('phone|phone2'=>$minfo['phone'],'class_id'=>$class_id))->getField('name',true);                    if(empty($student_name_arr))                    {                        $first='您好，亲爱的'.  $minfo['real_name'].'老师';                    }                    else                    {                        $first='您好，亲爱的'.  implode(',', $student_name_arr).'家长';                       }                    $args['first']=$first;                    $args['keyword1']=$classInfo['grade'].$classInfo['name'];                    $args['keyword2']=$former;                    $args['keyword3']=date('Y年m月d日 H:i',NOW_TIME);                    $args['keyword4']=$message_type.'-'.$data['title'];                    $args['remark']=  '请点击查看';                    $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$openid.'&typename=0&typeid='.$read_id;                                        $temp_send_arr[]=array('OPENTM204533457',$args,$openid,$url);                                    }            }        }               if(!empty($temp_send_arr))        {            //群发通过长连接服务发送            $host=substr(C('WEB_DOMAIN'),7,-1);            $WS =  new \Lib\WebsocketClient($host,C('WEB_SOCKET_PORT'));            $send_data=array('send_temp_message'=>$temp_send_arr);            $WS->sendData($send_data);        }        if($form_member_info['openid']!='')        {            //查询出关联小孩的名字            $student_name_arr=$Model->table('__STUDENT__')->where(array('phone|phone2'=>$form_member_info['phone'],'class_id'=>$class_id))->getField('name',true);            if(empty($student_name_arr))            {                $first='您好，亲爱的'.  $minfo['real_name'].'老师';            }            else            {                $first='您好，亲爱的'.  implode(',', $student_name_arr).'家长';               }            $args['first']=$first;            $args['keyword1']=$classInfo['grade'].$classInfo['name'];            $args['keyword2']='我';            $args['keyword3']=date('Y年m月d日 H:i',NOW_TIME);            $args['keyword4']=$message_type.'-'.$data['title'];            $args['remark']=  '请点击查看';            $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$form_member_info['openid'].'&typename=2&typeid='.$data['id'];            //给发送者推送微信消息            $WxMessage=new \Lib\Message();            if(false===$WxMessage->send('OPENTM204533457', $args, $form_member_info['openid'],$url))            {//                $this->error=$WxMessage->getError();//                return false;            }        }    }}