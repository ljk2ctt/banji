<?phpnamespace Home\Model;class HomeworkModel extends \Common\Model\HomeworkModel {    protected $_validate = array(        array('title', 'require', '请填写作业标题！',self::MUST_VALIDATE),        array('content', 'require', '请填写作业内容！',self::MUST_VALIDATE),        array('class_id', 'require', '请选择班级！',self::MUST_VALIDATE),    );    protected $_auto  =array(        array('addtime',NOW_TIME),    );    public $member_ids;    protected function _before_insert(&$data, $options) {        if(false===parent::_before_insert($data, $options))        {            return false;        }        $Model  =   M();        $map['m.id']=$data['member_id'];        $map['_string']='m.teacher_id=tsca.teacher_id and tsca.class_id='.$data['class_id'];        $subject_id=$Model->table('__MEMBER__ m,__TEACHER_SUBJECT_CLASS_ACCESS__ tsca')->where($map)->getField('tsca.subject_id');        if(empty($subject_id))        {            $this->error='您并未任教该班级';            return false;        }        $data['subject_id']=$subject_id;    }    protected function _after_insert($data, $options) {        $class_id   =   $data['class_id'];        $cinfo=M('Class')->find($class_id);        if(empty($cinfo))        {            $this->error='所选班级不存在';            return false;        }           $Model  =   M();               $parent_member_query=$Model->table('__MEMBER__ m')                ->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','left')                ->where(array('s.class_id'=>$class_id))->field('m.id id')->select();        foreach ($parent_member_query as $member_id)        {            $parent_member_ids[]=$member_id['id'];        }                $parent_member_ids=  array_unique($parent_member_ids);        $readdata['homework_id']=$data['id'];        $form_member_info=D('Member')->find($data['member_id']);        if (preg_match("/^[\x81-\xfe][\x40-\xfe]?/",$form_member_info['real_name'])) {            $former=substr($form_member_info['real_name'], 0,3);        }        else        {            $former=  substr($form_member_info['real_name'], 0,1);        }        $former.='老师';                    foreach($form_member_info['tinfo']['cinfos'] as $class)        {            if($class['id']==$class_id)            {                $former.='('.$class['my_role']['subject'].')';                $subject=$class['my_role']['subject'];                break;            }        }                $temp_send_arr=array();        $this->member_ids=$parent_member_ids;        foreach($parent_member_ids as $member_id)        {            $student_infos=$Model->table('__MEMBER__ m')->join('__STUDENT__ s on s.phone=m.phone or s.phone2=m.phone','LEFT')->where(array('s.class_id'=>$data['class_id'],'m.id'=>$member_id))->select();            $student_ids=array();            foreach($student_infos as $student_info)            {                $student_ids[]=$student_info['id'];            }                    $readdata['student_ids']=  implode(',', $student_ids);            $readdata['member_id']=$member_id;            $read_id=$Model->table('__HOMEWORK_READ__')->add($readdata);            $minfo=$Model->table('__MEMBER__')->find($member_id);            $openid=$minfo['openid'];            if($openid!='')            {                //查询出关联小孩的名字                $student_name_arr=$Model->table('__STUDENT__')->where(array('phone|phone2'=>$minfo['phone'],'class_id'=>$class_id))->getField('name',true);                if(empty($student_name_arr))                {                    continue;                }                $args['first']='您好，亲爱的'.  implode(',', $student_name_arr).'家长';                $args['name']=implode(',', $student_name_arr);                $args['subject']=$subject;                $args['content']=$data['title'];                $args['remark']=  '请点击查看';                $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$openid.'&typename=1&typeid='.$read_id;                $temp_send_arr[]=array('TM00376',$args,$openid,$url);               }        }        if(!empty($temp_send_arr))        {            //群发通过长连接服务发送            $host=substr(C('WEB_DOMAIN'),7,-1);            $WS =  new \Lib\WebsocketClient($host,C('WEB_SOCKET_PORT'));            $send_data=array('send_temp_message'=>$temp_send_arr);            $WS->sendData($send_data);        }        $WxMessage=new \Lib\Message();        if($form_member_info['openid']!='')        {            //查询出关联小孩的名字                    $classInfo  =   $Model->table('__CLASS__')->find($class_id);            $first='您好，亲爱的'.  $subject.'老师'.$form_member_info['real_name'];                    $args['first']=$first;            $args['keyword1']=$classInfo['grade'].$classInfo['name'];            $args['keyword2']='我';            $args['keyword3']=date('Y年m月d日 H:i',NOW_TIME);            $args['keyword4']='发布作业'.'-'.$data['title'].'-发布成功';            $args['remark']=  '请点击查看';            $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$form_member_info['openid'].'&typename=3&typeid='.$data['id'];            //给发送者推送微信消息            if(false===$WxMessage->send('OPENTM204533457', $args, $form_member_info['openid'],$url))            {//                $this->error=$WxMessage->getError();//                return false;            }        }    }}