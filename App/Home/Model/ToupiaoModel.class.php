<?phpnamespace Home\Model;use Think\Model;class ToupiaoModel extends Model {    protected $_validate = array(        array('app_id', 'require', '请选择支出项目！',self::MUST_VALIDATE),        array('pta_id', 'require', '请传入家委会！',self::MUST_VALIDATE),    );    protected $_auto  =array(        array('addtime',NOW_TIME),    );    protected function _before_insert(&$data, $options) {        //判断是否投过同意票        $yitou=$this->where(array('app_id'=>$data['app_id'],'pta_id'=>$data['pta_id'],'is_pass'=>1))->find();        if($yitou)        {            $this->error='该项目您已经投过同意票了';            return false;        }    }    protected function _after_insert($data, $options) {                //投票成功后 发不申请者发送系统通知消息        $OutpayApply    =   D('OutpayApply');        $oinfo=$OutpayApply->find($data['app_id']);        if($oinfo['is_check']==1)        {            $this->error='该项目已经通过审核';            return false;        }        $member_id=$oinfo['member_id'];        $Memssage   =   D('Message');        $mdata['class_id']=$oinfo['class_id'];        $mdata['type']=1;//1系统消息        $mdata['group_id']=4;//通知指定人        $Memssage->member_ids=$member_id;        $mdata['title']='班费'.($oinfo['money']>0?'支出':'退款').'申请反馈';         $mdata['content']='项目名:'.$oinfo['title'].',当前通过'.intval($oinfo['pass_info']['pass_num']).'人，还有（'.intval($oinfo['pta_num']-$oinfo['pass_info']['pass_num']).'）人未通过。';         if($oinfo['pta_num']>$oinfo['pass_info']['pass_num'])        {            if(false===$Memssage->create($mdata) || false===$Memssage->add())            {                $this->error=$Memssage->getError();                return false;            }        }        //推送微信消息        $WxMessage  =   new \Lib\Message();        $jieguo =   $data['is_pass']=='1'?'通过':'不通过';        $openid=$oinfo['minfo']['openid'];        if(!empty($openid))        {            $args['first']='您的申请:'.$oinfo['title'].'有了反馈';            $args['keyword1']='支出申请';            $args['keyword2']=$jieguo;            $args['keyword3']=date('Y年m月d日 H:i',NOW_TIME);            $args['remark']='当前通过'.intval($oinfo['pass_info']['pass_num']).'人，还有（'.intval($oinfo['pta_num']-$oinfo['pass_info']['pass_num']).'）人未通过。';            if(intval($oinfo['pta_num']-$oinfo['pass_num'])===0)            {                                $args['remark']='全体家委会已通过。';            }                        $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$openid.'&typename=4&typeid='.$oinfo['class_id'];               if(false===$WxMessage->send('OPENTM400501478', $args, $openid,$url))            {            }        }                //判断是否投票全票通过 给家委会发布出款通知        if($oinfo['pta_num']==$oinfo['pass_info']['pass_num'])        {            //修改为已通过            $OutpayApply->where($oinfo)->setField('is_check',1);            $mdata['class_id']=$oinfo['class_id'];            $mdata['type']=1;//1系统消息                  $mdata['group_id']=2;//家委会                   $mdata['title']='班费'.($oinfo['money']>0?'支出':'退款').'通过';                         $mdata['content']=$oinfo['money']>0?'全体家委会通过，项目名:'.$oinfo['title'].'请尽快联系拨款。支出金额'.abs($oinfo['money']).'元':'全体家委会通过，项目名:'.$oinfo['title'].'。退款金额'.abs($oinfo['money']).'元，款已退回班费总余额。';            if(false===$Memssage->create($mdata) || false===$Memssage->add())            {                $this->error=$Memssage->getError();                return false;            }            $mdata['class_id']=$oinfo['class_id'];            $mdata['type']=1;//1系统消息                  $mdata['group_id']=4;//指定人            $student_arr=explode(',',$oinfo['student_ids']);            $student_count=count($student_arr);            $member_ids =   M()->table('__STUDENT__ s')->join('__MEMBER__ m on s.phone=m.phone or s.phone2=m.phone','left')->where(array('s.id'=>array('in',$oinfo['student_ids']),'m.phone'=>array('neq','')))->field('m.id')->select();                        $mids=array();            foreach($member_ids as $member_id)            {                $mids[]=$member_id['id'];            }            if(!empty($mids))            {                //再次判断 避免出错                if($oinfo['money']*100 % $student_count !=0)                {                    $tuijian= floor($oinfo['money']*100/$student_count)/100*$student_count;                    $this->error='(第二次判断)总金额'.$data['money'] .'元不能平摊到受影响的学生'.$student_count.'人，推荐接近金额'.$tuijian.'元';                    return false;                }                //计算人均减少金额                $one_money=  $oinfo['money']/$student_count;                $Memssage->member_ids=implode(',', $mids);                $mdata['title']='班费'.($oinfo['money']>0?'支出':'退款').'已经通过审核';                 $mdata['content']='将'.($oinfo['money']>0?'支出':'退还').'您孩子个人班费。'.($oinfo['money']>0?'支出':'退款').'金额'.abs($one_money).'元';                if(false===$Memssage->create($mdata) || false===$Memssage->add())                {                    $this->error=$Memssage->getError();                    return false;                }            }            //资金处理            //班级总账            $ClassMoneyLog=D('ClassMoneyLog');            $cmlmap['class_id']=$oinfo['class_id'];            if(false===$now_money_info=$ClassMoneyLog->where($cmlmap)->order('id desc')->find())            {                $this->error=$ClassMoneyLog->getError();                return false;            }            $cmldata['class_id']=$oinfo['class_id'];            $cmldata['note']='班费'.($oinfo['money']>0?'支出':'退款').'，项目：'.$oinfo['title'].'。';            $cmldata['app_id']=$oinfo['id'];            $cmldata['type']=1;            $cmldata['money']=$oinfo['money'];            if(false===$ClassMoneyLog->create($cmldata) || false===$class_money_id=$ClassMoneyLog->add())            {                $this->error=$ClassMoneyLog->getError();                return false;            }            $StudentMoneyLog    =   D('StudentMoneyLog');            //学生各人余额                           foreach($student_arr as $student_id)                            {                $smldata['student_id']=$student_id;                $smldata['note']='班费'.($oinfo['money']>0?'支出':'退款').'，项目：'.$oinfo['title'].'。';                $smldata['type']=1;                $smldata['class_money_id']=$class_money_id;                $smldata['money']=$one_money;                if(false===$StudentMoneyLog->create($smldata) || false===$StudentMoneyLog->add())                {                    $this->error=$StudentMoneyLog->getError();                    return false;                }            }             $WxMessage=new \Lib\Message();              foreach($student_arr as $student_id)                            {                $sinfo=M()->table('__STUDENT__')->find($student_id);                $sname=$sinfo['name'];                $smoney=$sinfo['money'];                $cinfo=M()->table('__CLASS__')->find($oinfo['class_id']);                $cname=$cinfo['grade'].$cinfo['name'];                                $args['first']='您好，'.$sname.'所在班级'.$cname.'班费余额发生变化';                $args['keyword1']=date('Y年m月d日 H:i',NOW_TIME);                $args['keyword2']='班费'.($oinfo['money']>0?'支出':'退款').'-'.$oinfo['title'];                $args['keyword3']=($oinfo['money']>0?'-':'').abs($one_money).'元';                $args['remark']='当前总余额'.$smoney.'元,点击查看详情';                $openids=M()->table('__MEMBER__')->where(array('phone'=>array('in',array($sinfo['phone'],$sinfo['phone2']))))->getField('openid',true);                foreach($openids as $openid)                {                    $url=C('WEB_DOMAIN').JS_PROJECT_DIR.'/index.html#/tab_money.html?openid='.$openid.'&typename=5&typeid='.$student_id;                       if(false===$WxMessage->send('OPENTM207664902',$args,$openid,$url))                    {                    }                }            }        }            }}