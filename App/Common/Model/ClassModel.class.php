<?phpnamespace Common\Model;use Think\Model;class ClassModel extends Model {    protected function _after_select(&$resultSet, $options) {        foreach($resultSet as &$result)        {            if(false===$this->_after_find($result, $options))            {                return false;            }        }    }    protected function _after_find(&$result, $options) {        //增加3秒缓存 防止循环重复查询数据库        $result['sinfo']=D('School')->cache(true,3)->find($result['school_id']);        //获取通讯录人数        $Model  =M('');        $teachers=$Model->table('__MEMBER__ m')->join('__TEACHER_SUBJECT_CLASS_ACCESS__ tsca on tsca.teacher_id=m.teacher_id','left')->where(array('tsca.class_id'=>$result['id']))->count();        $membbers=$Model->table('__STUDENT__ s')->join('__MEMBER__ m on s.phone=m.phone','left')->where(array('s.class_id'=>$result['id']))->count();        $result['class_member_list_count']=  intval($teachers+$membbers);        $pats=$Model->table('__MEMBER__ m')->join('__PTA__ p on find_in_set(p.id,m.pta_id)','left')->where(array('p.class_id'=>$result['id']))->count();        $result['pat_count']=$pats;        $pta_list=$Model->table('__MEMBER__ m')->join('__PTA__ p on find_in_set(p.id,m.pta_id)','left')->where(array('p.class_id'=>$result['id']))->select();        foreach($pta_list as &$pta_one)        {            if (preg_match("/^[\x81-\xfe][\x40-\xfe]?/",$pta_one['real_name'])) {                $pta_one['first_name']=substr($pta_one['real_name'], 0,3);            }            else            {                $pta_one['first_name']=  substr($pta_one['real_name'], 0,1);            }                        $student_names=$Model->table('__STUDENT__')->where(array('phone|phone2'=>$pta_one['phone'],'class_id'=>$result['id']))->getField('name',true);            $pta_one['sun_names']=  implode(',', $student_names);        }        $result['pta_list']=$pta_list;        $ClassMoneyLog=D('ClassMoneyLog');        $result['class_money']=$ClassMoneyLog->where(array('class_id'=>$result['id']))->order('id desc')->getField('now_money');            }}