<?phpnamespace Common\Model;use Think\Model;class MessageCommentModel extends Model {    protected $_validate = array(        array('message_id', 'require', '缺少message_id！',self::MUST_VALIDATE),        array('member_id', 'require', '缺少member_id！',self::MUST_VALIDATE),        array('content', 'require', '请填写评论内容！',self::MUST_VALIDATE),    );    protected $_auto  =array(        array('addtime',NOW_TIME),    );    protected function _before_insert(&$data, $options) {        $message_info   =   M('Message')->find($data['message_id']);        if(empty($message_info))        {            $this->error='不存在的消息';            return false;        }        if($message_info['member_id']==0)        {            $this->error='系统消息，不允许评论';            return false;        }        if($message_info['member_id']!=$data['member_id'])        {              $read_info  = M('MessageRead')->where(array('message_id'=>$data['message_id'],'member_id'=>$data['member_id']))->find();            if(empty($read_info))            {                $this->error='您不是该消息的发布者或接受者不能评论';                return false;            }        }        if(!empty($data['reply_id']))        {            $rinfo=$data;            while ($rinfo['reply_id']!=0)            {                $rinfo=M('MessageComment')->where(array('id'=>$rinfo['reply_id']))->find();                if($rinfo['is_delete']==1)                {                    $this->error='评论已经删除';                    return false;                }            }            $data['freply_id']=$rinfo['id'];        }    }    protected function _after_update($data, $options) {        if(isset($data['is_delete']) && 1==$data['is_delete'])        {            //如果是删除 删除下级所有评论                        $rinfo=M('MessageComment')->where(array('reply_id'=>$data['id']))->find();            if(!empty($rinfo))            {                $this->where($rinfo)->setField('is_delete',1);            }                    }    }    protected function _after_select(&$resultSet, $options) {        foreach($resultSet as &$result)        {            if(false===$this->_after_find($result, $options))            {                return false;            }        }    }    protected function _after_find(&$result, $options) {        $Model  =   M();        $result['minfo']=M('Member')->find($result['member_id']);        $students=$Model->table('__STUDENT__ s')->join('__MESSAGE__ m on m.class_id=s.class_id','left')->where(array('m.id'=>$result['message_id'],'_string'=>'s.phone='.$result['minfo']['phone'].' or s.phone2='.$result['minfo']['phone']))->select();                //        foreach($students as $student)//        {//            if($result['minfo']['phone']==$student['phone'])//            {//                $guanxi=$student['family_ties']?$student['family_ties']:'家长';//            }//            else{//                $guanxi=$student['family_ties2']?$student['family_ties2']:'家长';//            }//            $result['minfo']['real_name'].='-'.$student['name']."($guanxi)";//        }                $student=$students[0];        if($student)        {            if($result['minfo']['phone']==$student['phone'])            {                $guanxi=$student['family_ties']?$student['family_ties']:'家长';            }            else{                $guanxi=$student['family_ties2']?$student['family_ties2']:'家长';            }            $result['minfo']['real_name']=$students[0]['name'].$guanxi;        }        if(empty($result['freply_id']))        {            $result['replyinfo']=$this->where(array('freply_id'=>$result['id'],'is_delete'=>0))->order('addtime')->select();        }        else{            $rmember_id=$this->where(array('id'=>$result['reply_id']))->getField('member_id');            $result['rminfo']=M('Member')->find($rmember_id);             $class_id=$Model->table('__MESSAGE__')->getFieldById($result['message_id'],'class_id');            $students=$Model->table('__STUDENT__')->where(array('class_id'=>$class_id,'_string'=>'phone='.$result['rminfo']['phone'].' or phone2='.$result['rminfo']['phone']))->select();    //        foreach($students as $student)    //        {    //            if($result['minfo']['phone']==$student['phone'])    //            {    //                $guanxi=$student['family_ties']?$student['family_ties']:'家长';    //            }    //            else{    //                $guanxi=$student['family_ties2']?$student['family_ties2']:'家长';    //            }    //            $result['minfo']['real_name'].='-'.$student['name']."($guanxi)";    //        }            $student=$students[0];            if($student)            {                if($result['rminfo']['phone']==$student['phone'])                {                    $guanxi=$student['family_ties']?$student['family_ties']:'家长';                }                else{                    $guanxi=$student['family_ties2']?$student['family_ties2']:'家长';                }                $result['rminfo']['real_name']=$students[0]['name'].$guanxi;            }        }        if(empty($result['replyinfo']))        {            $result['replyinfo']=array();        }    }}