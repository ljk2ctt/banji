<?phpnamespace Common\Model;use Think\Model;class MemberModel extends Model {    protected function _after_select(&$resultSet, $options) {        foreach($resultSet as &$result)        {            if(false===$this->_after_find($result, $options))            {                return false;            }        }    }    protected function _after_find(&$result, $options) {        $result['tinfo']=D('Teacher')->getById($result['teacher_id']);        $result['suns']=D('Student')->where(array('phone|phone2'=>$result['phone']))->select();        $result['ptainfo']=$result['pta_id']?M('Pta')->where(array('id'=>array('in',$result['pta_id'])))->select():'';        $result['pta_class_ids']=$result['pta_id']?M('Pta')->where(array('id'=>array('in',$result['pta_id'])))->getField('class_id',true):array();        $can_send_message_class_ids=$result['pta_class_ids'];        foreach($result['tinfo']['cinfos'] as $class)        {            //作为教师所有的班级id            $result['tea_classes'][]=$class;            $can_send_message_class_ids[]=$class['id'];            $teach_class_ids[]=$class['id'];            if(!array_key_exists($class['id'], $my_classes))            {                $my_classes[$class['id']]=$class;            }        }        $result['sun_ids']=array();        foreach($result['suns'] as &$sun)        {            $result['sun_ids'][]=$sun['id'];            if(empty($sun['cinfo']))            {                continue;            }            $is_pta='0';            if(!empty($result['pta_class_ids']))            {                if(in_array($sun['cinfo']['id'], $result['pta_class_ids']))                {                    $is_pta='1';                    $can_toupiao=M('Pta')->where(array('class_id'=>$sun['cinfo']['id'],'id'=>array('in',$result['pta_id'])))->getField('can_toupiao');                }                            }            if($result['phone']==$sun['phone'])            {                $family_ties=$sun['family_ties'];            }            else            {                $family_ties=$sun['family_ties2'];            }            $sun['this_family_ties']=$family_ties;            if(isset($sun['cinfo']['my_role']))            {                $sun['cinfo']['my_role']['role']='parent_and_teacher';                $sun['cinfo']['my_role']['is_pta']=$is_pta;                $sun['cinfo']['my_role']['family_ties']=$family_ties;            }            else            {                                //1 班主任 2 财务家委会 3老师 4家长 5普通家委会                $role_code=('0'===$is_pta)?4:($can_toupiao==1?2:5);                   unset($can_toupiao);                $sun['cinfo']['my_role']=array('role'=>'parent','is_pta'=>$is_pta,'family_ties'=>$family_ties,'role_code'=>$role_code);            }            //作为家长所有的班级id            $result['stu_classes'][]=$sun['cinfo'];                         $stu_class_ids[]=$sun['cinfo']['id'];            if(!array_key_exists($sun['cinfo']['id'], $my_classes))            {                $my_classes[$sun['cinfo']['id']]=$sun['cinfo'];            }        }        $result['can_send_message_class_ids']=$can_send_message_class_ids;        $result['teach_class_ids']=$teach_class_ids;        $result['stu_class_ids']=$stu_class_ids;        $result['my_classes']=  array_values($my_classes);    }}